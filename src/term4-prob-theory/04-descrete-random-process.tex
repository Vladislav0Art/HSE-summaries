\Subsection{Условные математические ожидания}

\begin{definition}
    $(\Omega, \mathcal{F}, P)$ - вероятностное пространство, $\xi : \Omega \to \mathbb{R}$ и $\mathbb{E} |\xi| < +\infty$. Пусть $\mathcal{A} \subset \mathcal{F}$ и $\mathcal{A}$ - $\sigma-$алгебра.

    $\mathbb{E} (\xi | \mathcal{A}) = \eta \, : \, \Omega \to \mathbb{R}$ - случайная величина, которая:

    \begin{enumerate}
        \item измерима относительно $\mathcal{A}$
        \item $\forall \, A \in \mathbb{A} \, : \, \mathbb{E} (\xi \mathds{1}_A) = \mathbb{E} (\eta \mathds{1}_A)$
    \end{enumerate}
\end{definition}

\begin{theorem}
    $\mathcal{A} \subset \mathcal{F}, \mathbb{E} |\xi| < +\infty$, тогда $\mathbb{E} (\xi | \mathcal{A})$ существует и единственно, с точностью до почти наверное
\end{theorem}

\begin{proof}
    Существование:

    $\xi = \xi_+ - \xi_-$. Пусть $A \in \mathcal{A}$, определим $\mu_{\pm} A = \int_A \xi_{\pm} \, dP$ - это конечные меры на $\mathcal{A}$, так как интеграл от измеримой неотрицательной функции.
    А ещё эти меры абсолютно непрерывны относительно $P \overset{\text{т. Радона-Никодима}}{\implies} \exists \, \eta_{\pm} > 0$ измеримые относительно $\mathcal{A}$, т.ч. $\mu_{\pm} A = \int_A \eta_{\pm} \, dP$
    
    $\eta = \eta_+ - \eta_-$, надо проверить, что $\forall \, A \in \mathcal{A} \, : \, \underbrace{\mathbb{E} (\xi \mathds{1}_A)}_{\mathbb{E}(\xi_+ \mathds{1}_A) - \mathbb{E}(\xi_- \mathds{1}_A)} = \mathbb{E} (\eta \mathds{1}_A)$

    А ещё $\mathbb{E}(\xi_+ \mathds{1}_A) = \mu_+ A = \int_A \xi_+ \, dP$ и для остальных точно также

    Единственность:

    Пусть $\eta_1$ и $\eta_2$ - условные матожидания. Тогда $\{ \eta_1 > \eta_2 \} \in \mathcal{A}$

    $\mathbb{E} (\eta_1 \mathds{1}_A) = \mathbb{E} (\xi \mathds{1}_A) = \mathbb{E} (\eta_2 \mathds{1}_A) \implies \underbrace{\mathbb{E} ((\eta_1 - \eta_2) \mathds{1}_A)}_{=\int_A (\eta_1 - \eta_2) \, dP} = 0 \implies P(A) = P(\eta_1 > \eta_2) = 0$. Аналогично $P(\eta_1 < \eta_2) = 0$
\end{proof}

\begin{properties}
    \begin{enumerate}
        \item $\mathbb{E} (c | \mathcal{A}) = c$
        \item $\mathbb{E} (\xi | \mathcal{A})$ линейно по $\xi$
        \item {$\xi \leqslant \eta$, то $\mathbb{E} (\xi | \mathcal{A}) \leqslant \mathbb{E} (\eta | \mathcal{A})$
            \begin{proof}
                Достаточно проверить, что если $\xi \geqslant 0$, то $\mathbb{E} (\xi | \mathcal{A}) \geqslant 0$
            \end{proof}
        }
        \item {
            $\mathbb{E} (\xi | \{ \emptyset, \Omega \}) = \mathbb{E} \xi$

            \begin{proof}
                Измеримы относительно такой $\sigma$-алгебры только константы. Надо проверить, что $\mathbb{E} (\mathbb{E} \xi \mathds{1}_A) = \mathbb{E} (\xi \mathds{1}_A)$ для $A = \emptyset$ и $A = \Omega$
            \end{proof}
        }
        \item {
            $\mathcal{F} \supset \mathcal{A}_1 \supset \mathcal{A}_2$ - $\sigma$-алгебры

            Тогда $\mathbb{E} (\mathbb{E} (\xi | \mathcal{A}_1) | \mathcal{A}_2) = \mathbb{E} (\xi | \mathcal{A}_2)$

            \begin{proof}
                $\eta = \mathbb{E} (\xi | \mathcal{A}_2)$ и $\zeta = \mathbb{E} (\xi | \mathcal{A}_1)$

                Надо доказать, что $\eta = \mathbb{E} (\zeta | \mathcal{A}_2)$. $\eta$ измерима относительно $\mathcal{A_2}$. Надо проверить, что 
                $\forall \, A \in \mathcal{A}_2 \, : \, \mathbb{E} (\eta \mathds{1}_A) = \mathbb{E} (\zeta \mathds{1}_A) = \mathbb{E} (\xi \mathds{1}_A)$, т.к. $A \in \mathcal{A}_1$ по определению $\zeta$. А ещё
                $\mathbb{E} (\xi \mathds{1}_A) = \mathbb{E} (\eta \mathds{1}_A)$
            \end{proof}
        }
        \item {
            $\mathbb{E} (\mathbb{E} (\xi | \mathcal{A})) = \mathbb{E} \xi$ - из $4$ и $5$
        }
        \item {
            Если $\xi$ измерима относительно $\mathcal{A}$, о $\mathbb{E} (\xi | \mathcal{A}) = \xi$
        }
    \end{enumerate}
\end{properties}

\begin{example}
    % дизъюнктно
    Пусть $\Omega = \bigcup A_k$  не более чем счётное объединение

    $\mathcal{A}$ - натянутая на $A_1, A_2, \ldots$ $\sigma-$алгебра

    $\mathbb{E} (\xi | \mathcal{A}) = ?$

    Если $\eta$ измерима относительно $\mathcal{A} \implies \eta = \sum c_k \mathds{1}_{A_k}$

    Нужно чтобы $\mathbb{E} (\xi \mathds{1}_{A_n}) = \mathbb{E} (\underbrace{\eta \mathds{1}_{A_n}}_{c_n \mathds{1}_{A_n}}) = c_n P(A_n)$

    То есть $c_n = \frac{\mathbb{E} (\xi \mathds{1}_{A_n})}{P(A_n)}$

    \begin{remark}
        Из свойства 6: $\mathbb{E} \xi = \mathbb{E} \eta = \sum \frac{\mathbb{E} (\xi \mathds{1}_{A_k})}{P(A_k)} \cdot P(A_k)$
    \end{remark}
\end{example}

\begin{definition}
    Условная вероятность относительно $\sigma$-алгебры

    $P(B | \mathcal{A}) = \mathbb{E} (\mathds{1}_B | \mathcal{A})$
\end{definition}

\begin{example}
    $\xi_1, \xi_2, \ldots$ - независимые, одинаково распределённые случайные величины, $N$ - случайная величина с неотрицательными целыми значениями, не зависящая от $\xi_1, \ldots$

    $S = \xi_1 + \ldots + \xi_{N}$

    Пусть $A_n = \{ N = n \}$

    $\mathbb{E} S = \sum\limits_{n = 0}^{+\infty} \frac{\mathbb{E} (S \mathds{1}_{A_n})}{P(A_n)} \cdot P(A_n) = \sum\limits_{n = 0}^\infty na P(N = n) = \mathbb{E} \xi_1 \cdot \mathbb{E} N$

    $\frac{\mathbb{E} (S \mathds{1}_{A_n})}{P(A_n)} = \mathbb{E} (S | N = n) = \mathbb{E} (S_n | N = n) = \mathbb{E} (\xi_1 + \ldots + \xi_n | N = n) \overset{\text{незаисимость}}{=} = \mathbb{E} (\xi_1 + \ldots + \xi_n) = na$, где $a = \mathbb{E} \xi_1$
\end{example}

\begin{example}
    Пусть $\xi_k$ тоже принимают неотрицательные целые значения

    Тогда $G_{\xi_1} (t) = G(t)$ - производящая функция $\xi_k$

    $G_S (t) = \mathbb{E} t^S = \sum_{n = 0}^\infty \frac{\mathbb{E} (t^S \mathds{1}_{A_n})}{P(A_n)} \cdot P(A_n) = \sum\limits_{n = 0}^\infty G^n (t) P(N = n) = G_n (G_{\xi} (t))$

    $\frac{\mathbb{E} (t^S \mathds{1}_{A_n})}{P(A_n)} = \mathbb{E} (t^S | N = n) = \mathbb{E} (t^{S_n} | N = n) = \mathbb{E} (t^{\xi_1} \cdot \ldots \cdot t^{\xi_n} | N = n) = \mathbb{E} (t^{\xi_1} \cdot \ldots \cdot e^{\xi_n}) = (\mathbb{E} t^{\xi_1})^n = (G(t))^n$
\end{example}

\begin{remark}
    \textbf{Геометрическая интерпретация}

    Пусть $\mathbb{E} \xi^2 < +\infty$

    Тогда $\xi \in L^2 (\Omega, \mathcal{F}, P)$. $\mathcal{A} \subset \mathcal{F}$ - $\sigma$ - алгебра. Поэтому
    $\underbrace{L^2 (\Omega, \mathcal{A}, P)}_{\text{замкнутое подпространство}} \subset L^2 (\Omega, \mathcal{F}, P)$

    $\eta = \mathbb{E} (\xi | \mathcal{A})$ - тогда проекция $\xi$ на $L^2 (\Omega, \mathcal{A}, P)$

    Нужно проверить, что $\xi - \eta \bot L^2 (\Omega, \mathcal{A}, P)$

    В $L^2$ плотны ступенчатые, давайте проверим для них, а потом сделаем предельный переход. Достаточно даже понять только для 1 ступеньки.

    Достаточно понять, что $\forall \, A \in \mathcal{A} \, : \, \xi - \eta \bot \mathds{1}_A$

    $0 \overset{?}{=} \left < \xi - \eta, \mathds{1}_A \right > = \mathbb{E} ((\xi - \eta)\mathds{1}_A) = \mathbb{E}(\xi \mathds{1}_A) - \mathbb{E} (\eta \mathds{1}_A)$
\end{remark}

\begin{definition}
    $\eta$ - случайная величина. Пусть $\sigma (\eta)$ - наименьшая $\sigma$-алгебра, относительно которой $\eta$ измерима 
    
    \begin{remark}
        Чтобы её получить, нужно взять все Лебеговы множества и натянуть на них $\sigma$-алгебру
    \end{remark} 
\end{definition}

\begin{definition}
    $\mathbb{E} (\xi | \eta) = \mathbb{E} (\xi | \sigma (\eta))$ - условное матожидание $\xi$ относительно $\eta$
\end{definition}

\begin{example}
    $\eta$ - дискретная, $\{ y_1, y_2, \ldots \}$ - множество её значений

    Все $ \{ \eta = y_k \}$ - измеримы, $\Omega = \bigcup \{ \eta = y_k \} $, $\sigma (\eta)$ - всевозможные объединения $\{ \eta = y_k \}$ 
\end{example}

\begin{theorem}
    \begin{enumerate}
        \item Если $\xi$ и $\eta$ независимы, то $\mathbb{E}(\xi | \eta) = \mathbb{E} \xi$
        \item Если $\eta$ измерима относительно $\mathcal{A}$, то $\mathbb{E} (\xi \eta | \mathcal{A}) = \eta \mathbb{E} (\xi | \mathcal{A})$
    \end{enumerate}
\end{theorem}

\begin{proof}
    \begin{enumerate}
        \item {
            Надо доказать, что $\forall \, A \in \sigma(\eta) \, : \, \mathbb{E} (\xi \mathds{1}_A) \overset{?}{=} \mathbb{E} (\mathbb{E} \xi \cdot \mathds{1}_A) =
            \mathbb{E} \xi \mathbb{E} \mathds{1}_A$

            То есть достаоточно проверить, что $\xi$ и $\mathds{1}_A$ независимы

            Пусть $A = \{ \eta \leqslant a \}$. $P(\xi \in B, \mathds{1}_A \in C) = P(\xi \in B) \cdot P(\mathds{1}_A \in C)$

            Достаточно рассмотреть только $C = \{ 0 \}$ и $C = \{ 1 \}$

            $P (\xi \in B, \mathds{1}_A = 1) = P(\xi \in B, \eta \leqslant a) \overset{\text{независимость $\xi$ и $\eta$}}{=} P(\xi \in B) P(\eta \leqslant a) = P(\xi \in B) P(\mathds{1}_A = 1)$. Для $\mathds{1}_A = 0$ аналогично

            Для Лебеговых множеств мы это получили, поэтому есть и для любых праобразов ячеек
        }
        \item {
            Проверяем для $\eta = \mathds{1}_A$, где $A \in \mathcal{A}$

            $\mathds{1}_A \mathbb{E} (\xi | \mathcal{A})$ - условное матожидание $\mathbb{E} (\xi \mathds{1}_A | \mathcal{A})$

            Измеримость есть, поэтому достаточно проверить только второе условие

            $\forall \, B \in \mathcal{A} \, : \, \underbrace{\mathbb{E} (\xi \mathds{1}_A \cdot \mathds{1}_B)}_{=\mathbb{E} (\xi \mathds{1}_{A \cap B})} \overset{?}{=} \underbrace{\mathbb{E} (\mathds{1}_A \mathbb{E} (\xi | \mathcal{A}) \mathds{1}_B)}_{=\mathbb{E} (\mathds{1}_{A \cap B} \mathbb{E} (\xi | \mathcal{A}))}$

            Тогда по линейности верно для простых $\eta$, по теореме Леви предельный переход $\eta_n \rightarrow \eta$ поточечно. 

            Мы знаем, что есть равенство $\underbrace{\mathbb{E} (\xi \eta_n \mathds{1}_B)}_{=\int_{\Omega} \xi \eta_n \mathds{1}_B \, dP} = \underbrace{\mathbb{E} (\eta_n \mathbb{E} (\xi | \mathcal{A}) \mathds{1}_B)}_{=\int_{\Omega} \eta_n \mathbb{E} (\xi | \mathcal{A} \mathds{1}_B \, dP)}$

            Предельный переход можно делать для $\eta_+$ и $\eta_-$, сделаем, потом перейдём к $\eta$
        }
    \end{enumerate}
\end{proof}

\Subsection{Ветвящиеся процессы}

$\xi_{nk}$ - независимые случаные величины с неотрицательными целыми значениями

Интерпретация - есть много частиц, которые размножаются/умирают. Тогда $n$ - момент времени, $k$ - номер частицы, $\xi_{nk}$ - количество её потомков

$\eta_n = \xi_{n1} + \xi_{n2} + \ldots + \xi_{n\eta_{n-1}}$ - количество частиц в момент $n$

$\eta_0 = 1$ - изначально у нас есть только 1 частица

Считаем, что все $\xi_{nk}$ одинаково распределены и $P(\xi_{nk} = m) = f_m$. 

$F(t) = \sum\limits_{m=0}^\infty f_m t^m$ - производящая функция

Пусть $G_n (t)$ - производящая функция для $\eta_n$. Тогда $G_n (t) = G_{n-1} (F (t)) = F \circ F \circ F \ldots \circ F (t)$ - результат был получен в примере выше.

$\mathbb{E} \eta_n = G_n' (1) = G_{n-1}' (\underbrace{F(1)}_{=1}) \cdot \underbrace{F' (1)}_{= \mathbb{E} \xi} = \mathbb{E} \xi \cdot \mathbb{E} \eta_{n-1} = (\mathbb{E} \xi)^n$

\begin{theorem}
    Вероятность вырождения процесса - наименьший неотрицательный корень уравнения $F(x) = x$
\end{theorem}

\begin{proof}
    $A_n = \{ \eta_n = 0 \}$ - на $n$-ном шаге не осталось частиц

    $P(A_n) = G_n (0) \leqslant 1$, а ещё $A_1 \subset A_2 \subset \ldots$ - если процесс выродился, то он и останется вырожденным.

    Поэтому у нас существует предел $q = \lim P(A_n) \leqslant 1$

    $\underbrace{G_{n + 1} (0)}_{\rightarrow q} = \underbrace{F(G_n (0))}_{F(q)}$, а $F$ непрерывная, поэтому $q = F(q)$, поэтому веротяность - корень уравнения. Осталось понять, что это
    наименьший корень

    Пусть $r$ другой корень уравнения $r = F(r)$. Ещё мы знаем, что $F$ монотонна, потому что производная неотрицательная (просто коэффициенты неотрицательны).

    $P(A_1) = G_1 (0) = F(0) \overset{\text{монотонность}}{\leqslant} F(r) = r$ - верно в стартовый момент времени.

    Пусть $P(A_n) \leqslant r$, тогда $P(A_{n + 1}) = G_{n + 1} (0) = F(G_n (0))  = F(P(A_n)) \leqslant F(r) = r$

    Переходим к пределу и получаем, что $q \leqslant r$
\end{proof}

\begin{remark}
    $F$ непрерывная, монотонная, выпуклая на $[0, 1]$, а ещё $F(1) = 1$ и $F(0) \geqslant 0$

    %TODO, картинка

    Если $m = \mathbb{E} \xi = F' (1) > 1$, то есть вероятность вырождения $< 1$, если же $m \leqslant 1$, то вероятность вырождения $= 1$
\end{remark}

\begin{theorem}
    Пусть $m = \mathbb{E} \xi = 1$, $b = \mathbb{D} \xi > 0$, $q_n$ - вероятность вырождения к $n$-ному шагу, $\gamma_n = q_n - q_{n-1}$ - вероятность вырождения ровно на $n$-ном шаге.

    Тогда
    \begin{enumerate}
        \item $\gamma_n \sim \frac{2}{bn^2}$
        \item $1 - q_n \sim \frac{2}{bn}$
    \end{enumerate}
\end{theorem}

\begin{proof}
    Пусть $p_n = 1 - q_n$ и $H(x) = 1 - F(1 - x)$

    Тогда $H(p_n) = 1 - F(q_n) = 1 - q_{n+1} = p_{n+1}$, $H(0) = 1 - F(1) = 0$, $H'(0) = F'(1) = 1$, $H''(x) = F''(1 - x)$ и тогда $H''(0) = -F''(1) = -b$

    В итоге $H(x) = x - \frac{bx^2}{2} + o(x^2)$

    Пусть $a_n = \frac{1}{p_n}$, $a_n - a_{n-1} = \frac{1}{p_n} - \frac{1}{p_{n-1}} = \frac{p_{n-1} - p_n}{p_np_{n-1}} = \frac{p_{n-1} - H(p_{n-1})}{p_{n-1}H(p_{n-1})} = 
    \frac{\frac{bp_{n-1}^2}{2} + o(p_{n-1}^2)}{p_{n-1}(p_{n-1} + o(p_{n-1}))} = \frac{b}{2} + o(1) \implies a_n \sim \frac{bn}{2}$

    Тогда $p_n \sim \frac{2}{bn}$

    $\gamma_n = q_{n} - q_{n- 1} = p_{n-1} - p_n = p_{n-1} - H(p_{n-1}) = \frac{bp_{n-1}^2}{2} + o(p_{n-1}^2) \sim \frac{bp_{n-1}^2}{2} \sim \frac{b}{2} \left( \frac{2}{bn} \right)^2 = \frac{2}{bn^2}$
\end{proof}

\Subsection{Цепи Маркова}

\begin{definition}
    $Y$, не более чем счётное множество - фазовое пространство

    $(\Omega, \mathcal{F}, P)$ - вероятностное пространство, $\xi_n \, : \, \Omega \to Y$ - случайная величина, такая, что
    $P(\xi_n = a_n | \xi_{n - 1} = a_{n - 1}, \ldots, \xi_0 = a_0) = P(\xi_n = a_n | \xi_{n - 1} = a_{n-1}) \, \forall a_0, a_1, \ldots, a_n \in Y$

    Такая последовательность $\xi_n$ - цепь Маркова

    \begin{remark}
        То есть $\xi_n$ зависит только от $\xi_{n-1}$
    \end{remark}
\end{definition}

\begin{example}
    \begin{enumerate}
        \item {
            Случайное блуждание по $\mathbb{Z}$

            $P(\xi_n = \xi_{n-1} + 1) = p$
            
            $P(\xi_n = \xi_{n-1} - 1) = 1 - p$
        }
        \item {
            Прибор, который бывает в двух состояниях - работает и не работает.

            % Тут нужна картинка
        }
    \end{enumerate}
    \begin{remark}
        $\pi_0 = P_{\xi_0}$ - начальное распределение

        $p_n (a, b) = P(\xi_n = b | \xi_{n - 1} = a)$ - вероятностости переходов. Этот набор данных однозначно определяет все распределения
    \end{remark}
\end{example}

\begin{definition}
    Цепь Маркова называется однородной, если $p_n (a, b)$ не зависят от $n$. 

    То есть вероятности переходов не зависят от времени

    \textit{Обозначение.} $p_n (a, b) = p_{ab}$
\end{definition}

\begin{remark}
    Интерпретация: есть частица, которая бегает по фазовому пространству. И мы в каждый момент фиксируем место, где находится частица.
\end{remark}

\begin{definition}
    Траектория: $\xi_0 = a_0, \xi_1 = a_1, \ldots, \xi_n = a_n$
\end{definition}

\begin{theorem}
    $P(\xi_0 = a_0, \ldots, \xi_n = a_n) = \pi_0(a_0)p_{a_0a_1}p_{a_1a_2}\ldots p_{a_{n-1}a_n}$
\end{theorem}

\begin{proof}
    Индукция по $n$

    \begin{enumerate}
        \item База индукция - определение $\pi_0$
        \item {
            Переход: $n - 1 \to n$

            $P(\xi_0 = a_0, \ldots, \xi_n = a_n) = P(\xi_n = a_n | \xi_{n - 1} = a_{n-1}, \ldots, \xi_0 = a_0) \cdot P(\xi_{n - 1} = a_{n-1}, \ldots, \xi_0 = a_0) 
            = \underbrace{P(\xi_n = a_n | \xi_{n - 1} = a_{n-1})}_{=p_{a_{n-1}a_n}} \cdot \pi_0 (a_0) p_{a_0a_1} \ldots p_{a_{n-2}a_{n-1}}$
        }
    \end{enumerate}
\end{proof}

\begin{theorem}
    Пусть $\pi_0 \, : \, Y \to [0, 1]$, т.ч. $\sum\limits_{y \in Y} \pi_0 (y) = 1$, $p \, : \, Y \times Y \to [0, 1]$, т.ч.
    $\sum\limits_{y \in Y} p_{ay} = 1 \, \forall \, a \in Y$

    Тогда существует такое пространство $(\Omega, \mathcal{F}, P)$ и последовательность $\xi_n \, : \, \Omega \to Y$, такая, что
    $\xi_n$ цепь Маркова с начальным распределением $\pi_0$ и вероятностью перехода $p_{ab}$
\end{theorem}

\textit{Обозначение. } $\pi_n = P_{\xi_n}$ и $P$ - матрица $(p_{ab})_{a, b \in Y}$

\begin{theorem}
    $\pi_n = \pi_0 P^n$
\end{theorem}

\begin{proof}
    Индукция по $n$. Переход $n-1 \to n$

    $\pi_n (b) = P(\xi_n = b) = \sum\limits_{y \in Y} P(\xi_n = b | \xi_{n-1} = y) \cdot P(\xi_{n-1} = y) = \sum\limits_{y \in Y}p_{yb} \pi_{n-1}(y)$

    То есть $\pi_n = \pi_{n-1} P$
\end{proof}

\textit{Обозначение. } $p_{ab} (n) = P(\xi_{n + k} = b | \xi_k = a)$ - вероятность перехода за $n$ шагов

\begin{definition}
    $\pi \, : \, Y \to [0, 1]$ - распределение на $Y$, если $\sum\limits_{y \in Y} \pi (y) = 1$
\end{definition}

\begin{definition}
    $\pi$ - стационарное распределение для цепи Маркова, если $\pi = \pi P$
\end{definition}

\begin{example}
    Симметричное случайное блуждание на $\mathbb{Z}$, то есть $p = \frac{1}{2}$

    Пусть $\pi$ - стационарное распределение для этого блуждания

    Тогда $\frac{1}{2} \pi (n - 1) + \frac{1}{2} \pi (n + 1) = \pi (n) \Longleftrightarrow \pi (n) - \pi (n - 1) = \pi (n + 1) - \pi (n)$, то есть разность $\alpha = \pi (n) - \pi (n - 1)$ не зависит от $n$

    \begin{enumerate}
        \item $\alpha > 0$, то $\pi (n) = n\alpha + \pi (0) \rightarrow +\infty$, так не бывает
        \item $\alpha < 0$, то $\pi (n) = n\alpha + \pi (0) \rightarrow -\infty$, так тоже не бывает
        \item $\alpha = 0$ и $\pi = const$, но так тоже не бывает 
    \end{enumerate}
\end{example}

\begin{theorem}
    \textbf{Эргодическая теорема Маркова}

    $\xi_n$ - конечная цепь Маркова и $p_{ab} > 0 \, \forall \, a, b \in Y$

    Тогда существует единственное стационарное распределение и $\pi (b) = \lim_{n \to \infty} p_{ab} (n)$

    Более того, $|\pi (b) - p_{ab} (n) | \leqslant cq^n $, где $q \in (0, 1)$
\end{theorem}

\begin{proof}
    Доказательство с использованием теоремы Банаха о сжатии из матанализа

    $d$ - количество элементов в $Y$. Рассмотрим $\mathbb{R}^d$ с нормой $||x|| = |x_1| + \ldots + |x_d|$ - полное пространство

    $S = \{ x \in \mathbb{R}^d \, : \, ||x|| = 1, x_1, x_2, \ldots, x_d \geqslant 0 \}$ - замкнутое подмножество $\mathbb{R}^d$ - полное

    $T \, : \, S \to S$ и $T(x) = x^{T} P$, $\delta = \min\limits_{a, b \in Y} p_{ab} > 0$

    Проверяем, что $T$ - сжатие с $\lambda = 1 - d\delta$

    $||T_x - T_y|| \overset{z = x - y}{=} ||T_z|| = \sum\limits_{j = 1}^d |(T_z)_j| = \sum\limits_{j = 1}^d \left | \sum\limits_{k = 1}^d z_k p_{kj} \right | = 
    \sum\limits_{j = 1}^d \left | \sum\limits_{k = 1}^d z_k (p_{kj} - \delta) + \delta \underbrace{\sum\limits_{k = 1}^d z_k}_{= 0} \right | \leqslant \sum\limits_{j = 1}^d \sum\limits_{k = 1}^d |z_k| (p_{kj} - \delta) = 
    \sum\limits_{k = 1}^d |z_k| \sum\limits_{j = 1}^d \underbrace{(p_{kj} - \delta)}_{=1 - \delta d = \lambda} = \lambda \sum\limits_{k = 1}^d |z_k| = \lambda ||x - y|| $
\end{proof}

\begin{remark}
    Пусть $\xi_n$ - конечная цепь Маркова, $m \in \mathbb{N}$, т.ч. $p_{ab} (m) > 0 \, \forall a, b \in Y$

    Тогда существует единственное стационарное распределение
\end{remark}

\begin{definition}
    Состояние $b$ достижимо из $a$, если $\exists \, n \in \mathbb{N}$, т.ч. $p_{ab} (n) > 0$
\end{definition}

\begin{definition}
    Состояния $a$ и $b$ сообщающиеся, если $a$ достижимо из $b$, а $b$ достижимо из $a$
\end{definition}

\begin{definition}
    Состояние $a$ существенное, если $\forall \, b$, достижимого из $a$ - состояния $a$ и $b$ сообщающиеся
\end{definition}

\textit{Обозначение. } $f_{a} (n) = P(\xi_n = a | x_{n - 1} \neq a, \xi_{n - 2} \neq a, \ldots, \xi_1 \neq a, \xi_0 = a)$ - вероятность, стартовав из $a$, впервые вернуться назад на $n$-ном шаге.

$F_a = \sum\limits_{n = 1}^\infty f_{a} (n)$ - вероятность возврата назад в $a$

\begin{definition}
    $a$ - возвратное состояние, если $F_a = 1$
\end{definition}

\begin{definition}
    $a$ - нулевое состояние, если $p_{aa} (n) \rightarrow 0$
\end{definition}

\begin{theorem}
    \textbf{Критерий возвратности}

    $a$ - возвратное $\Longleftrightarrow$ $(*) = P_a = \sum\limits_{n = 1}^\infty p_{aa} (n)$ расходится

    И если $a$ не возвратное, то $F_a = \frac{P_a}{1 + P_a}$
\end{theorem}

\begin{lemma}
    $c_n \geqslant 0$ и $\sum_{n=0}^{\infty} c_n = +\infty$. 

    Тогда $\lim\limits_{x\to 1-} \sum_{n=0}^{\infty} c_nx^n = +\infty$
\end{lemma}

\begin{proof}
    Берём $n$, т.ч. $\sum_{k=0}^{n} c_k > A$, а $\sum_{k=1}^{n} \rightarrow_{x\to 1-} \sum_{n=0}^{n}c_k$. Тогда
    $\underbrace{\sum_{k=0}^{n} c_kx^k}_{\leqslant \sum_{n=0}^{\infty} c_nx^n} > A - 1$ при $x$ близких к 1
\end{proof}

\begin{proof}
    Теоремы

    Давайте считать, что $p_{aa} (0) = 1$ и $f_a (0) = 0$

    $\mathcal{F} (z) = \sum_{n=0}^{\infty} f_a (n) z^n$, сходится при $|z| \leqslant 1$

    $\mathcal{P} (z) = \sum_{n=0}^{\infty} p_{aa} (n)z^n$, сходится при $|z| < 1$

    $p_{aa} (n) = \sum_{k = 0}^{n} f_a (k) p_{aa} (n - k)$ - верно при $n \geqslant 1$

    Тогда $\mathcal{P} (z) = \mathcal{F} (z) \mathcal{P} (z)$ - почти верное равенство, надо ещё подкорректировать при $z^0$.
    Получим $\mathcal{P} (z) = \mathcal{F} (z) \mathcal{P} (z) + 1 \implies \mathcal{F} (z) = \frac{\mathcal{P} (z) - 1}{\mathcal{P} (z)}$. Давайте устремим $z \to 1$
    
    $\underbrace{\lim\limits_{z \to 1-} \mathcal{F} (z)}_{=F_a} = \lim\limits_{z \to 1-} \frac{\mathcal{P} (z) - 1}{\mathcal{P} (z)} \overset{\text{если $(*)$ сходится}}{=} \frac{P_a}{P_a + 1}$.

    А если расходится, то смотрим на $\underbrace{(1 - \mathcal{F} (z))}_{\to 1 - F_a} \underbrace{\mathcal{P} (z)}_{\to 1 + P_a} = 1$. Отсюда получаем, что $F_a = 1$
\end{proof}

\begin{consequence}
    Если $a$ не возвратное $\implies$ $a$ - нулевое
\end{consequence}

\begin{theorem}
    \textbf{Теорема солидарности}

    $a$ и $b$ сообщающиеся состояния

    Тогда они возвратны/не возвратны (нулевые/не нулевые) одновременно
\end{theorem}

\begin{proof}
    $a$ и $b$ сообщающиеся, значит $\exists \,  j, k \in \mathbb{N} \, : \, p_{ab} (j) > 0$ и $p_{ba} (k) > 0$

    $p_{aa} (n + j + k) \geqslant p_{ab} (j) p_{bb} (n) p_{ba} (k)$ и $\sum\limits_{n = 1}^\infty p_{aa} (n + j + k) \geqslant p_{ab} (j) p_{ba} (k) \sum\limits_{n = 1}^\infty p_{bb} (n)$

    Отсюда всё следует, потому что:

    Если $p_{aa} (n + j + k) \rightarrow 0$, то $p_{bb} (n) \rightarrow 0$
    
\end{proof}

\begin{theorem}
    \textbf{ЗБЧ для цепей Маркова}

    $\varepsilon > 0$ и цепь удовлетворяет условию теоремы Маркова, $\pi$ - стационарное распределение  
    
    Тогда 
    \begin{enumerate}
        \item $P\left( \left| \frac{\nu_a (n)}{n} - \pi (a) \right| \geqslant \varepsilon \right) \rightarrow 0$
        \item $P\left( \left| \frac{\nu_{ab} (n)}{n} - \pi (a) p_{ab} \right| \geqslant \varepsilon \right) \rightarrow 0$
    \end{enumerate}

    Здесь $\nu_a (n)$ - количество значений $\xi_1, \ldots, \xi_n$, равных $a$
    
    $\nu_{ab} (n)$ - количество пар $ab$ на соседних позициях
\end{theorem}

\begin{proof}
    Пусть $\eta_k = 
    \begin{cases}
        1, & \text{если $\xi_k = a$}\\
        0, & \text{иначе}    
    \end{cases}$

    $\tilde{\eta_k} = 
    \begin{cases}
        1, & \text{если $\xi_k = a$ и $\xi_{k + 1} = b$}\\
        0, & \text{иначе}    
    \end{cases}$

    Тогда $\nu_a (n) = \eta_1 + \ldots + \eta_n$ и $\nu_{ab} (n) = \tilde{\eta_1} + \ldots + \tilde{\eta_n}$

    Посмотрим на $\mathbb{E} \eta_k = P(\xi_k = a) = \sum\limits_{y \in Y} \pi_0(y) \underbrace{p_{ya} (k)}_{\rightarrow \pi (a)} \rightarrow \pi (a)$

    Значит $\mathbb{E} \frac{\nu_a (n)}{n} = \frac{1}{n} \sum\limits_{n=1}^{n} \mathbb{E} \eta_k \rightarrow \pi (a)$

    По аналогии считаем для второй ситуации:

    $\mathbb{E} \tilde{\eta_k} = P(\xi_k = a, \xi_{k + 1} = b) = \sum\limits_{y \in Y} \pi_0 (y) \underbrace{p_{ya}}_{\rightarrow \pi (a)} (k) p_{ab}  \rightarrow \pi (a) p_{ab}$

    $\mathbb{E} \frac{\eta_{ab} (n)}{n} = \frac{1}{n} \sum\limits_{k=1}^{n} \mathbb{E} \tilde{\eta_k}$

    Пишем Чебышёва: $P \left( \left| \frac{\nu_a (n)}{n} - \mathbb{E} \frac{\nu_a (n)}{n} \right| \geqslant \varepsilon \right) \leqslant \frac{\mathbb{D} \left( \frac{\nu_a (n)}{n} \right)}{\varepsilon^2} = \frac{\mathbb{D} \nu_a (n)}{\varepsilon^2 n^2}$

    $\mathbb{D} \nu_a (n) = \mathbb{D} (\sum_{k=1}^{n} \eta_k) = \underbrace{\sum_{k = 1}^{n} \mathbb{D} \eta_k}_{\leqslant n} + 2\sum\limits_{i < j} cov (\eta_i, \eta_j)$

    Давайте как-то оценим ковариацию:

    $cov (\xi_i, \xi_j) = \mathbb{E} (\eta_i, \eta_j) - \mathbb{E} \eta_i \mathbb{E} \eta_j$

    Здесь $\mathbb{E} (\eta_i \eta_j) = P(\xi_i = a, \xi_j = a) = \sum\limits_{y \in Y} \pi_0 (y) \underbrace{p_{ya} (i)}_{= \pi (a) + \mathcal{O}(\lambda^i)} \underbrace{p_{aa} (j - i)}_{\pi (a) + \mathcal{O} (\lambda^{j - i})} = \pi^2 (a) + \mathcal{O} (\lambda^i) + \mathcal{O} (\lambda^{j - i}) + \mathcal{O} (\lambda^i)$

    $\mathbb{E} \eta_i = P(\xi_i = a) = \sum\limits_{y \in Y} \pi_0 (y) \underbrace{p_{ya} (i)}_{\pi (a) + \mathcal{O} (\lambda^i)} = \pi (a) + \mathcal{O} (\lambda^i)$ 

    Мы поняли, что $cov (\eta_i, \eta_j) = \mathcal{O} (\lambda^i) + \mathcal{O} (\lambda^{j - i})$ и эти ковариации надо просуммировать

    $\sum\limits_{i < j} cov (\eta_i, \eta_j) = \sum\limits_{i < j} \left(\mathcal{O} (\lambda^i) + \mathcal{O} (\lambda^{j - i})\right) = \mathcal{O} (n)$

    Осталось заметить, что $\{ \left| \frac{\nu_a (n)}{n} - \pi (a) \right| \geqslant \varepsilon \} \subset \{ \left| \frac{\nu_a (n)}{n} - \mathbb{E} \frac{\nu_a (n)}{n} \right| \geqslant \frac{\varepsilon}{2} \}$.

    Мы поностью доказали первый пункт, во втором аналогично оценивается дисперсия
\end{proof}

\Subsection{Случайные блуждания}

\begin{theorem}
    Рассмотрим блуждание по прямой

    Блуждание возвратно $\Longleftrightarrow p = \frac{1}{2}$
\end{theorem}

\begin{proof}
    Возвратность $\Longleftrightarrow$ $\sum\limits_{n=1}^\infty p_{00} (n) = +\infty$

    $p_{00} (2n - 1) = 0$

    $p_{00} (2n) = p^n (1-p)^n \binom{2n}{n} \sim \frac{4^n}{\sqrt{\pi n}} (p(1-p))^n $

    Если $p \neq \frac{1}{2}$, то $4p (1 - 1p) < 1$ и $p_{00} (2n) \leqslant C (4p(1-p))^n $ - сходящаяся геометрическая прогрессия

    Если $p = \frac{1}{2}$, то $p_{00} (n) \sim \frac{1}{\sqrt{\pi n}} \implies$ ряд расходится
\end{proof}

\begin{remark}
    
Симметричное блуждание по $\mathbb{Z}$. Возьмём $\eta_k$ независимые одинаково распределённые случайные величины, т.ч. $P(\eta_k = a) = P(\eta_k = -a)$ и $\xi_n = \eta_1 + \ldots + \eta_n$

\end{remark}

\begin{proof}
    Если $\eta_1$ имеет матожидание, то блуждание возвратно
\end{proof}

\begin{proof}
    $G$ - производящая функция для $\eta_1$. То есть $G(z) = \sum\limits_{k \in \mathbb{Z}} P(\eta_1 = k) z^k$

    $G_{\xi_n} (z) = (G(z))^n$. Нас интересует $p_{00} (n) = P(\xi_n = 0)$ - коэффициент при $z^0$ в $G_{\xi_n}$ - подставить 0 в ряд Лорана не можем. Зато умеем считать вычет:

    $p_{00} (n) = \frac{1}{2\pi i} \int\limits_{|z| = 1} \frac{G^n (z)}{z} \, dz$

    $\sum\limits_{n=0}^\infty p_{00} (n)x^n = \sum\limits_{n = 0}^\infty \frac{1}{2\pi i} \int\limits_{|z| = 1} \frac{G^n (z) x^n}{z} \, dz \overset{?}{=} \frac{1}{2\pi i} \int\limits_{|z| = 1} \frac{1}{z} \underbrace{\sum\limits_{n = 0}^\infty x^n G^n (z)}_{= \frac{1}{1 - xG(z)}} \, dz = 
    \frac{1}{2\pi} \int_{-\pi}^\pi \frac{dt}{1 - xG(e^{it})} = \frac{1}{\pi} \int_0^\pi \frac{dt}{1 - xG(e^{it})} \overset{{*}}{=} \frac{1}{\pi} \int_0^\pi \frac{dt}{1 - x + o(xt)} \geqslant \frac{1}{\pi} \int_0^\pi \frac{dt}{1 - x + xt} = \frac{1}{\pi} \frac{\ln (1 - x + xt)}{x} \bigg |_{t=0}^{t = \pi} \rightarrow +\infty$

    $(*) \, : \, G(1 + s) = G(1) + G' (1) \cdot s + o(s) = 1 + o(s)$. Тогда $G(e^{it}) = 1 + o(e^{it} - 1) = 1 + o(t)$
\end{proof}

\begin{remark}
    Все состояния нулевые

    $\underbrace{p_{00} (n)}_{? \, : \, \rightarrow 0} = \frac{1}{2\pi i} \int\limits_{|z| = 1} \frac{G^n (z)}{z} \, dz \rightarrow \frac{1}{2\pi i} \int\limits_{|z| = 1} \frac{\lim_{n\to \infty} G^n (z)}{z} \, dz$

    $\left| G(z) \right| = \left| \sum\limits_{n \in \mathbb{Z}} P(\eta = n) z^n \right| \leqslant \sum\limits_{n \in \mathbb{Z}} P(\eta = n) |z|^n = \sum\limits_{n \in \mathbb{Z}} P(\eta = n) = 1$

    $\left| \sum P(\eta = n) e^{int} \right| = \sum P(\eta = n)$

    Если $P(\eta = n) > 0$ и $P(\eta = k) > 0$, то $\arg e^{int} = \arg e^{ikt}$. То есть $nt = kt + 2\pi m \implies t = 2\pi \frac{m}{n - k} \in \pi \mathbb{Q}$ - счётное множество. Значит множество точек, в которых знак нестрогий - счётно.

    Значит $G^n (z) \rightarrow 0$ почти везде
\end{remark}