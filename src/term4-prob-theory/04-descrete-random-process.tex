\Subsection{Условные математические ожидания}

\begin{definition}
    $(\Omega, \mathcal{F}, P)$ - вероятностное пространство, $\xi : \Omega \to \mathbb{R}$ и $\mathbb{E} |\xi| < +\infty$. Пусть $\mathcal{A} \subset \mathcal{F}$ и $\mathcal{A}$ - $\sigma-$алгебра.

    $\mathbb{E} (\xi | \mathcal{A}) = \eta \, : \, \Omega \to \mathbb{R}$ - случайная величина, которая:

    \begin{enumerate}
        \item измерима относительно $\mathcal{A}$
        \item $\forall \, A \in \mathbb{A} \, : \, \mathbb{E} (\xi \mathds{1}_A) = \mathbb{E} (\eta \mathds{1}_A)$
    \end{enumerate}
\end{definition}

\begin{theorem}
    $\mathcal{A} \subset \mathcal{F}, \mathbb{E} |\xi| < +\infty$, тогда $\mathbb{E} (\xi | \mathcal{A})$ существует и единственно, с точностью до почти наверное
\end{theorem}

\begin{proof}
    Существование:

    $\xi = \xi_+ - \xi_-$. Пусть $A \in \mathcal{A}$, определим $\mu_{\pm} A = \int_A \xi_{\pm} \, dP$ - это конечные меры на $\mathcal{A}$, так как интеграл от измеримой неотрицательной функции.
    А ещё эти меры абсолютно непрерывны относительно $P \overset{\text{т. Радона-Никодима}}{\implies} \exists \, \eta_{\pm} > 0$ измеримые относительно $\mathcal{A}$, т.ч. $\mu_{\pm} A = \int_A \eta_{\pm} \, dP$
    
    $\eta = \eta_+ - \eta_-$, надо проверить, что $\forall \, A \in \mathcal{A} \, : \, \underbrace{\mathbb{E} (\xi \mathds{1}_A)}_{\mathbb{E}(\xi_+ \mathds{1}_A) - \mathbb{E}(\xi_- \mathds{1}_A)} = \mathbb{E} (\eta \mathds{1}_A)$

    А ещё $\mathbb{E}(\xi_+ \mathds{1}_A) = \mu_+ A = \int_A \xi_+ \, dP$ и для остальных точно также

    Единственность:

    Пусть $\eta_1$ и $\eta_2$ - условные матожидания. Тогда $\{ \eta_1 > \eta_2 \} \in \mathcal{A}$

    $\mathbb{E} (\eta_1 \mathds{1}_A) = \mathbb{E} (\xi \mathds{1}_A) = \mathbb{E} (\eta_2 \mathds{1}_A) \implies \underbrace{\mathbb{E} ((\eta_1 - \eta_2) \mathds{1}_A)}_{=\int_A (\eta_1 - \eta_2) \, dP} = 0 \implies P(A) = P(\eta_1 > \eta_2) = 0$. Аналогично $P(\eta_1 < \eta_2) = 0$
\end{proof}

\begin{properties}
    \begin{enumerate}
        \item $\mathbb{E} (c | \mathcal{A}) = c$
        \item $\mathbb{E} (\xi | \mathcal{A})$ линейно по $\xi$
        \item {$\xi \leqslant \eta$, то $\mathbb{E} (\xi | \mathcal{A}) \leqslant \mathbb{E} (\eta | \mathcal{A})$
            \begin{proof}
                Достаточно проверить, что если $\xi \geqslant 0$, то $\mathbb{E} (\xi | \mathcal{A}) \geqslant 0$
            \end{proof}
        }
        \item {
            $\mathbb{E} (\xi | \{ \emptyset, \Omega \}) = \mathbb{E} \xi$

            \begin{proof}
                Измеримы относительно такой $\sigma$-алгебры только константы. Надо проверить, что $\mathbb{E} (\mathbb{E} \xi \mathds{1}_A) = \mathbb{E} (\xi \mathds{1}_A)$ для $A = \emptyset$ и $A = \Omega$
            \end{proof}
        }
        \item {
            $\mathcal{F} \supset \mathcal{A}_1 \supset \mathcal{A}_2$ - $\sigma$-алгебры

            Тогда $\mathbb{E} (\mathbb{E} (\xi | \mathcal{A}_1) | \mathcal{A}_2) = \mathbb{E} (\xi | \mathcal{A}_2)$

            \begin{proof}
                $\eta = \mathbb{E} (\xi | \mathcal{A}_2)$ и $\zeta = \mathbb{E} (\xi | \mathcal{A}_1)$

                Надо доказать, что $\eta = \mathbb{E} (\zeta | \mathcal{A}_2)$. $\eta$ измерима относительно $\mathcal{A_2}$. Надо проверить, что 
                $\forall \, A \in \mathcal{A}_2 \, : \, \mathbb{E} (\eta \mathds{1}_A) = \mathbb{E} (\zeta \mathds{1}_A) = \mathbb{E} (\xi \mathds{1}_A)$, т.к. $A \in \mathcal{A}_1$ по определению $\zeta$. А ещё
                $\mathbb{E} (\xi \mathds{1}_A) = \mathbb{E} (\eta \mathds{1}_A)$
            \end{proof}
        }
        \item {
            $\mathbb{E} (\mathbb{E} (\xi | \mathcal{A})) = \mathbb{E} \xi$ - из $4$ и $5$
        }
        \item {
            Если $\xi$ измерима относительно $\mathcal{A}$, о $\mathbb{E} (\xi | \mathcal{A}) = \xi$
        }
    \end{enumerate}
\end{properties}

\begin{example}
    % дизъюнктно
    Пусть $\Omega = \bigcup A_k$  не более чем счётное объединение

    $\mathcal{A}$ - натянутая на $A_1, A_2, \ldots$ $\sigma-$алгебра

    $\mathbb{E} (\xi | \mathcal{A}) = ?$

    Если $\eta$ измерима относительно $\mathcal{A} \implies \eta = \sum c_k \mathds{1}_{A_k}$

    Нужно чтобы $\mathbb{E} (\xi \mathds{1}_{A_n}) = \mathbb{E} (\underbrace{\eta \mathds{1}_{A_n}}_{c_n \mathds{1}_{A_n}}) = c_n P(A_n)$

    То есть $c_n = \frac{\mathbb{E} (\xi \mathds{1}_{A_n})}{P(A_n)}$

    \begin{remark}
        Из свойства 6: $\mathbb{E} \xi = \mathbb{E} \eta = \sum \frac{\mathbb{E} (\xi \mathds{1}_{A_k})}{P(A_k)} \cdot P(A_k)$
    \end{remark}
\end{example}

\begin{definition}
    Условная вероятность относительно $\sigma$-алгебры

    $P(B | \mathcal{A}) = \mathbb{E} (\mathds{1}_B | \mathcal{A})$
\end{definition}

\begin{example}
    $\xi_1, \xi_2, \ldots$ - независимые, одинаково распределённые случайные величины, $N$ - случайная величина с неотрицательными целыми значениями, не зависящая от $\xi_1, \ldots$

    $S = \xi_1 + \ldots + \xi_{N}$

    Пусть $A_n = \{ N = n \}$

    $\mathbb{E} S = \sum\limits_{n = 0}^{+\infty} \frac{\mathbb{E} (S \mathds{1}_{A_n})}{P(A_n)} \cdot P(A_n) = \sum\limits_{n = 0}^\infty na P(N = n) = \mathbb{E} \xi_1 \cdot \mathbb{E} N$

    $\frac{\mathbb{E} (S \mathds{1}_{A_n})}{P(A_n)} = \mathbb{E} (S | N = n) = \mathbb{E} (S_n | N = n) = \mathbb{E} (\xi_1 + \ldots + \xi_n | N = n) \overset{\text{незаисимость}}{=} = \mathbb{E} (\xi_1 + \ldots + \xi_n) = na$, где $a = \mathbb{E} \xi_1$
\end{example}

\begin{example}
    Пусть $\xi_k$ тоже принимают неотрицательные целые значения

    Тогда $G_{\xi_1} (t) = G(t)$ - производящая функция $\xi_k$

    $G_S (t) = \mathbb{E} t^S = \sum_{n = 0}^\infty \frac{\mathbb{E} (t^S \mathds{1}_{A_n})}{P(A_n)} \cdot P(A_n) = \sum\limits_{n = 0}^\infty G^n (t) P(N = n) = G_n (G_{\xi} (t))$

    $\frac{\mathbb{E} (t^S \mathds{1}_{A_n})}{P(A_n)} = \mathbb{E} (t^S | N = n) = \mathbb{E} (t^{S_n} | N = n) = \mathbb{E} (t^{\xi_1} \cdot \ldots \cdot t^{\xi_n} | N = n) = \mathbb{E} (t^{\xi_1} \cdot \ldots \cdot e^{\xi_n}) = (\mathbb{E} t^{\xi_1})^n = (G(t))^n$
\end{example}

\begin{remark}
    \textbf{Геометрическая интерпретация}

    Пусть $\mathbb{E} \xi^2 < +\infty$

    Тогда $\xi \in L^2 (\Omega, \mathcal{F}, P)$. $\mathcal{A} \subset \mathcal{F}$ - $\sigma$ - алгебра. Поэтому
    $\underbrace{L^2 (\Omega, \mathcal{A}, P)}_{\text{замкнутое подпространство}} \subset L^2 (\Omega, \mathcal{F}, P)$

    $\eta = \mathbb{E} (\xi | \mathcal{A})$ - тогда проекция $\xi$ на $L^2 (\Omega, \mathcal{A}, P)$

    Нужно проверить, что $\xi - \eta \bot L^2 (\Omega, \mathcal{A}, P)$

    В $L^2$ плотны ступенчатые, давайте проверим для них, а потом сделаем предельный переход. Достаточно даже понять только для 1 ступеньки.

    Достаточно понять, что $\forall \, A \in \mathcal{A} \, : \, \xi - \eta \bot \mathds{1}_A$

    $0 \overset{?}{=} \left < \xi - \eta, \mathds{1}_A \right > = \mathbb{E} ((\xi - \eta)\mathds{1}_A) = \mathbb{E}(\xi \mathds{1}_A) - \mathbb{E} (\eta \mathds{1}_A)$
\end{remark}

\begin{definition}
    $\eta$ - случайная величина. Пусть $\sigma (\eta)$ - наименьшая $\sigma$-алгебра, относительно которой $\eta$ измерима 
    
    \begin{remark}
        Чтобы её получить, нужно взять все Лебеговы множества и натянуть на них $\sigma$-алгебру
    \end{remark} 
\end{definition}

\begin{definition}
    $\mathbb{E} (\xi | \eta) = \mathbb{E} (\xi | \sigma (\eta))$ - условное матожидание $\xi$ относительно $\eta$
\end{definition}

\begin{example}
    $\eta$ - дискретная, $\{ y_1, y_2, \ldots \}$ - множество её значений

    Все $ \{ \eta = y_k \}$ - измеримы, $\Omega = \bigcup \{ \eta = y_k \} $, $\sigma (\eta)$ - всевозможные объединения $\{ \eta = y_k \}$ 
\end{example}

\begin{theorem}
    \begin{enumerate}
        \item Если $\xi$ и $\eta$ независимы, то $\mathbb{E}(\xi | \eta) = \mathbb{E} \xi$
        \item Если $\eta$ измерима относительно $\mathcal{A}$, то $\mathbb{E} (\xi \eta | \mathcal{A}) = \eta \mathbb{E} (\xi | \mathcal{A})$
    \end{enumerate}
\end{theorem}

\begin{proof}
    \begin{enumerate}
        \item {
            Надо доказать, что $\forall \, A \in \sigma(\eta) \, : \, \mathbb{E} (\xi \mathds{1}_A) \overset{?}{=} \mathbb{E} (\mathbb{E} \xi \cdot \mathds{1}_A) =
            \mathbb{E} \xi \mathbb{E} \mathds{1}_A$

            То есть достаоточно проверить, что $\xi$ и $\mathds{1}_A$ независимы

            Пусть $A = \{ \eta \leqslant a \}$. $P(\xi \in B, \mathds{1}_A \in C) = P(\xi \in B) \cdot P(\mathds{1}_A \in C)$

            Достаточно рассмотреть только $C = \{ 0 \}$ и $C = \{ 1 \}$

            $P (\xi \in B, \mathds{1}_A = 1) = P(\xi \in B, \eta \leqslant a) \overset{\text{независимость $\xi$ и $\eta$}}{=} P(\xi \in B) P(\eta \leqslant a) = P(\xi \in B) P(\mathds{1}_A = 1)$. Для $\mathds{1}_A = 0$ аналогично

            Для Лебеговых множеств мы это получили, поэтому есть и для любых праобразов ячеек
        }
        \item {
            Проверяем для $\eta = \mathds{1}_A$, где $A \in \mathcal{A}$

            $\mathds{1}_A \mathbb{E} (\xi | \mathcal{A})$ - условное матожидание $\mathbb{E} (\xi \mathds{1}_A | \mathcal{A})$

            Измеримость есть, поэтому достаточно проверить только второе условие

            $\forall \, B \in \mathcal{A} \, : \, \underbrace{\mathbb{E} (\xi \mathds{1}_A \cdot \mathds{1}_B)}_{=\mathbb{E} (\xi \mathds{1}_{A \cap B})} \overset{?}{=} \underbrace{\mathbb{E} (\mathds{1}_A \mathbb{E} (\xi | \mathcal{A}) \mathds{1}_B)}_{=\mathbb{E} (\mathds{1}_{A \cap B} \mathbb{E} (\xi | \mathcal{A}))}$

            Тогда по линейности верно для простых $\eta$, по теореме Леви предельный переход $\eta_n \rightarrow \eta$ поточечно. 

            Мы знаем, что есть равенство $\underbrace{\mathbb{E} (\xi \eta_n \mathds{1}_B)}_{=\int_{\Omega} \xi \eta_n \mathds{1}_B \, dP} = \underbrace{\mathbb{E} (\eta_n \mathbb{E} (\xi | \mathcal{A}) \mathds{1}_B)}_{=\int_{\Omega} \eta_n \mathbb{E} (\xi | \mathcal{A} \mathds{1}_B \, dP)}$

            Предельный переход можно делать для $\eta_+$ и $\eta_-$, сделаем, потом перейдём к $\eta$
        }
    \end{enumerate}
\end{proof}

\Subsection{Ветвящиеся процессы}

$\xi_{nk}$ - независимые случаные величины с неотрицательными целыми значениями

Интерпретация - есть много частиц, которые размножаются/умирают. Тогда $n$ - момент времени, $k$ - номер частицы, $\xi_{nk}$ - количество её потомков

$\eta_n = \xi_{n1} + \xi_{n2} + \ldots + \xi_{n\eta_{n-1}}$ - количество частиц в момент $n$

$\eta_0 = 1$ - изначально у нас есть только 1 частица

Считаем, что все $\xi_{nk}$ одинаково распределены и $P(\xi_{nk} = m) = f_m$. 

$F(t) = \sum\limits_{m=0}^\infty f_m t^m$ - производящая функция

Пусть $G_n (t)$ - производящая функция для $\eta_n$. Тогда $G_n (t) = G_{n-1} (F (t)) = F \circ F \circ F \ldots \circ F (t)$ - результат был получен в примере выше.

$\mathbb{E} \eta_n = G_n' (1) = G_{n-1}' (\underbrace{F(1)}_{=1}) \cdot \underbrace{F' (1)}_{= \mathbb{E} \xi} = \mathbb{E} \xi \cdot \mathbb{E} \eta_{n-1} = (\mathbb{E} \xi)^n$

\begin{theorem}
    Вероятность вырождения процесса - наименьший неотрицательный корень уравнения $F(x) = x$
\end{theorem}

\begin{proof}
    $A_n = \{ \eta_n = 0 \}$ - на $n$-ном шаге не осталось частиц

    $P(A_n) = G_n (0) \leqslant 1$, а ещё $A_1 \subset A_2 \subset \ldots$ - если процесс выродился, то он и останется вырожденным.

    Поэтому у нас существует предел $q = \lim P(A_n) \leqslant 1$

    $\underbrace{G_{n + 1} (0)}_{\rightarrow q} = \underbrace{F(G_n (0))}_{F(q)}$, а $F$ непрерывная, поэтому $q = F(q)$, поэтому веротяность - корень уравнения. Осталось понять, что это
    наименьший корень

    Пусть $r$ другой корень уравнения $r = F(r)$. Ещё мы знаем, что $F$ монотонна, потому что производная неотрицательная (просто коэффициенты неотрицательны).

    $P(A_1) = G_1 (0) = F(0) \overset{\text{монотонность}}{\leqslant} F(r) = r$ - верно в стартовый момент времени.

    Пусть $P(A_n) \leqslant r$, тогда $P(A_{n + 1}) = G_{n + 1} (0) = F(G_n (0))  = F(P(A_n)) \leqslant F(r) = r$

    Переходим к пределу и получаем, что $q \leqslant r$
\end{proof}

\begin{remark}
    $F$ непрерывная, монотонная, выпуклая на $[0, 1]$, а ещё $F(1) = 1$ и $F(0) \geqslant 0$

    %TODO, картинка

    Если $m = \mathbb{E} \xi = F' (1) > 1$, то есть вероятность вырождения $< 1$, если же $m \leqslant 1$, то вероятность вырождения $= 1$
\end{remark}

\begin{theorem}
    Пусть $m = \mathbb{E} \xi = 1$, $b = \mathbb{D} \xi > 0$, $q_n$ - вероятность вырождения к $n$-ному шагу, $\gamma_n = q_n - q_{n-1}$ - вероятность вырождения ровно на $n$-ном шаге.

    Тогда
    \begin{enumerate}
        \item $\gamma_n \sim \frac{2}{bn^2}$
        \item $1 - q_n \sim \frac{2}{bn}$
    \end{enumerate}
\end{theorem}

\begin{proof}
    Пусть $p_n = 1 - q_n$ и $H(x) = 1 - F(1 - x)$

    Тогда $H(p_n) = 1 - F(q_n) = 1 - q_{n+1} = p_{n+1}$, $H(0) = 1 - F(1) = 0$, $H'(0) = F'(1) = 1$, $H''(x) = F''(1 - x)$ и тогда $H''(0) = -F''(1) = -b$

    В итоге $H(x) = x - \frac{bx^2}{2} + o(x^2)$

    Пусть $a_n = \frac{1}{p_n}$, $a_n - a_{n-1} = \frac{1}{p_n} - \frac{1}{p_{n-1}} = \frac{p_{n-1} - p_n}{p_np_{n-1}} = \frac{p_{n-1} - H(p_{n-1})}{p_{n-1}H(p_{n-1})} = 
    \frac{\frac{bp_{n-1}^2}{2} + o(p_{n-1}^2)}{p_{n-1}(p_{n-1} + o(p_{n-1}))} = \frac{b}{2} + o(1) \implies a_n \sim \frac{bn}{2}$

    Тогда $p_n \sim \frac{2}{bn}$

    $\gamma_n = q_{n} - q_{n- 1} = p_{n-1} - p_n = p_{n-1} - H(p_{n-1}) = \frac{bp_{n-1}^2}{2} + o(p_{n-1}^2) \sim \frac{bp_{n-1}^2}{2} \sim \frac{b}{2} \left( \frac{2}{bn} \right)^2 = \frac{2}{bn^2}$
\end{proof}